syntax = "proto3";

package eventsourcing.v1;

import "google/protobuf/timestamp.proto";

message EntityPair {
  int64 from_entity = 1;
  int64 to_entity = 2;
}

message ComponentTransaction {
  message ColumnIndex {
    uint32 table_index = 1;
    uint32 patch_field_index = 2;
  }

  message EntityPairPatch {
    EntityPair entity_pair = 1;
    int64 integrity_hash = 2;
    repeated ColumnIndex column_indices = 3;
  }

  message Patch {
    repeated EntityPair added_pairs = 1;
    repeated EntityPair removed_pairs = 2;
    repeated EntityPairPatch updated_entity_patches = 3;
  }

  repeated int64 i64s = 1;
  repeated double f64s = 2;
  repeated string texts = 3;
  repeated bytes binaries = 4;
  map<int64, Patch> component_patches = 5;
}

service EventStoreService {
  rpc Append(AppendRequest) returns (AppendResponse) {}
  rpc Events(EventsRequest) returns (EventsResponse) {}
}

message AppendRequest { ComponentTransaction transaction = 1; }

message AppendResponse {
  message EntityPairIntegrityHash {
    int64 component_entity = 1;
    EntityPair entity_pair = 2;
    int64 integrity_hash = 3;
  }
  repeated EntityPairIntegrityHash updated_entity_pairs = 1;
}

message EventsRequest {
  uint32 last_transaction_id = 1;
  uint32 limit = 2;
}

message EventsResponse {
  message Event {
    uint32 transaction_id = 1;
    google.protobuf.Timestamp created_at = 2;
    ComponentTransaction component_transaction = 3;
  }
  repeated Event events = 1;
}
